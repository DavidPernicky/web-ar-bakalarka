<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="UTF-8">
    <title>AR Vizitka</title>
    
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
      /* Hlavn√© tlaƒçidlo skenera */
      #scan-button {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        padding: 15px 25px;
        background-color: #00FF00;
        color: black;
        border: none;
        border-radius: 30px;
        font-weight: bold;
        text-transform: uppercase;
        box-shadow: 0px 4px 10px rgba(0,0,0,0.5);
        cursor: pointer;
      }

      /* Kontajner pre vyskakovac√≠ skener */
      #qr-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.95);
        z-index: 2000;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      #qr-reader {
        width: 80%;
        max-width: 300px;
        border: 2px solid #00FF00;
      }

      .close-btn {
        margin-top: 20px;
        padding: 10px 20px;
        background: red;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      /* Kontajner pre kontaktn√© tlaƒçidl√° */
      #contact-buttons {
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        display: none; 
        gap: 15px;
        font-family: sans-serif;
      }

      .contact-btn {
        padding: 12px 20px;
        background-color: #008CBA;
        color: white;
        text-decoration: none;
        border-radius: 25px;
        font-weight: bold;
        box-shadow: 0px 4px 10px rgba(0,0,0,0.5);
        text-align: center;
      }
    </style>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const currentID = urlParams.get('id');
      const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSQ-SFdCTOWEviIYJZSk0mwkyh6li8dnKCQB_LnLvrwEZklXjggD67hqnsx0kBIxoEUZoiqDNp_gfWF/pub?output=csv";

      // LOGIKA PRE NAƒå√çTANIE D√ÅT
      AFRAME.registerComponent('vcard-logic', {
        init: function () {
          if (!currentID) return;

          fetch(csvUrl)
            .then(response => response.arrayBuffer()) 
            .then(buffer => {
              const decoder = new TextDecoder('utf-8');
              const csvText = decoder.decode(buffer);
              
              const rows = csvText.split('\n');
              for (let i = 1; i < rows.length; i++) {
                const columns = rows[i].split(',');
                if (columns[0] && columns[0].trim() === currentID) {
                  const plneMeno = `${columns[1]} ${columns[2]} ${columns[3]} ${columns[4]}`.trim();
                  
                  // Nastavenie mena v AR
                  document.querySelector('#ar-meno').setAttribute('value', plneMeno);
                  
                  // Nastavenie HTML tlaƒçidiel na volanie a mail
                  document.getElementById('btn-volat').href = `tel:${columns[5].trim()}`;
                  document.getElementById('btn-pisat').href = `mailto:${columns[6].trim()}`;
                  
                  // Zobrazenie HTML tlaƒçidiel na obrazovke
                  document.getElementById('contact-buttons').style.display = 'flex';
                  break;
                }
              }
            })
            .catch(err => console.error("Chyba pri naƒç√≠tan√≠ CSV:", err));
        }
      });

      // TESTOVAC√ç SKRIPT NA KLIKNUTIE
      AFRAME.registerComponent('test-klik', {
        init: function () {
          this.el.addEventListener('click', () => {
            const meno = document.querySelector('#ar-meno');
            
            // Ulo≈æ√≠me si p√¥vodn√© meno
            const povodneMeno = meno.getAttribute('value');
            
            // Zmen√≠me text na ƒçerven√Ω n√°pis
            meno.setAttribute('value', 'KLIK FUNGUJE!');
            meno.setAttribute('color', '#FF0000');
            
            // Po 2 sekund√°ch to vr√°time sp√§≈•
            setTimeout(() => {
              meno.setAttribute('value', povodneMeno);
              meno.setAttribute('color', '#00FF00');
            }, 2000);
          });
        }
      });

      // LOGIKA PRE SKENER
      let html5QrCode;

      function openScanner() {
        document.getElementById('qr-overlay').style.display = 'flex';
        html5QrCode = new Html5Qrcode("qr-reader");
        
        html5QrCode.start(
          { facingMode: "environment" }, 
          { fps: 10, qrbox: 250 },
          (decodedText) => {
            window.location.href = decodedText;
          }
        ).catch(err => console.error("Chyba skenera:", err));
      }

      function closeScanner() {
        if (html5QrCode) {
          html5QrCode.stop().then(() => {
            document.getElementById('qr-overlay').style.display = 'none';
          });
        } else {
          document.getElementById('qr-overlay').style.display = 'none';
        }
      }
    </script>
  </head>
  
  <body style="margin: 0; overflow: hidden;">

    <button id="scan-button" onclick="openScanner()">Skenova≈• ƒèal≈°iu vizitku</button>
    <div id="contact-buttons">
      <a id="btn-volat" href="#" class="contact-btn">üìû</a>
      <a id="btn-pisat" href="#" class="contact-btn">‚úâÔ∏è</a>
    </div>

    <div id="qr-overlay">
      <h3 style="color:white;">Naskenujte QR kod</h3>
      <div id="qr-reader"></div>
      <button class="close-btn" onclick="closeScanner()">Zavrie≈•</button>
    </div>

    <a-scene mindar-image="imageTargetSrc: ./targets.mind; filterMinCF: 0.0001; filterBeta: 0.001;" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false" vcard-logic>
     <a-camera position="0 0 0" look-controls="enabled: false" cursor="fuse: false; rayOrigin: mouse;" raycaster="objects: .clickable"></a-camera>
      
      <a-entity mindar-image-target="targetIndex: 0">
        
        <a-plane position="0 0.85 0" width="1.2" height="0.3" color="#111111" opacity="0.9"></a-plane>
        
        <a-text id="ar-meno" value="Nacitavam..." color="#00FF00" position="-0.55 0.85 0.05" width="2.5"></a-text>

        <a-gltf-model src="./logokti.glb" 
               class="clickable"
               test-klik 
               scale="1.5 1.5 1.5" 
               position="-0.8 1.0 0.2"
               animation__float="property: position; from: -0.8 0.95 0.2; to: -0.8 1.05 0.2; dir: alternate; loop: true; dur: 2000; easing: easeInOutSine">
        </a-gltf-model>

      </a-entity>
    </a-scene>
  </body>
</html>